events {
    worker_connections 1024;
}

http {
    # Logging
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    # gRPC upstream for User Service
    upstream user_service {
        least_conn;
        server user-service:50051;
        # Add more instances here for load balancing
        # server user-service-2:50051;
        # server user-service-3:50051;
    }

    # gRPC upstream for Product Service
    upstream product_service {
        least_conn;
        server product-service:50052;
        # Add more instances here for load balancing
        # server product-service-2:50052;
        # server product-service-3:50052;
    }

    # gRPC upstream for Order Service
    upstream order_service {
        least_conn;
        server order-service:50053;
        # Add more instances here for load balancing
        # server order-service-2:50053;
        # server order-service-3:50053;
    }

    # HTTP/2 server for gRPC
    server {
        listen 9090 http2;

        # User Service gRPC
        location /user.UserService/ {
            grpc_pass grpc://user_service;
            grpc_connect_timeout 10s;
            grpc_send_timeout 10s;
            grpc_read_timeout 10s;
        }

        # Product Service gRPC
        location /product.ProductService/ {
            grpc_pass grpc://product_service;
            grpc_connect_timeout 10s;
            grpc_send_timeout 10s;
            grpc_read_timeout 10s;
        }

        # Order Service gRPC
        location /order.OrderService/ {
            grpc_pass grpc://order_service;
            grpc_connect_timeout 10s;
            grpc_send_timeout 10s;
            grpc_read_timeout 10s;
        }
    }
}

